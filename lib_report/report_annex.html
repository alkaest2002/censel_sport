{% extends "_base.html" %}

{% block style %}
<style>
    img {
        width: 100%;
    }

    .two-columns {
        height: 100dvh;
        column-count: 2;
        column-width: 50ch;
        column-gap: 2.5rem;
        column-fill: auto;
    }

    .two-columns table {
        break-inside: avoid;
    }

    .table-padded th,
    .table-padded td {
        padding: 0.3rem 1rem;
    }
</style>
{% endblock %}

{% block body %}
{% set format_float_number = "%." + data.metric_config.metric_precision | string + "f" %}
<!-- FIRST PAGE -->
<div class="page">
    <div class="content">
        <!-- Page Header -->
        <div class="mb-xxl">
            <div class="header">
                <h1 class="mb-xs">{{ data.metric_config.title | upper }}</h1>
                <p>Allegato {{ header }}1</p>
            </div>
        </div>

        <!-- Page Content -->
        <h2 class="mb-xl">Campione di riferimento</h2>
        <div class="two-columns">
            
            <div class="mb-xl">
                <h3 class="mb-lg background">NOTE INTRODUTTIVE</h3>
                <ul>
                    <li>
                        <p>
                            In questa pagina vengono presentate le informazioni relative al campione
                            utilizzato per la
                            costruzione della tavola di conversione relativa a: <span
                                class="text-italic text-underline">{{
                                data.metric_config.title | lower }}</span> (cfr all. {{ header }}3, pag. {{ page + 2 }}). Tale tavola consente la trasformazione dei
                            punteggi
                            grezzi in punteggi standardizzati.
                        </p>
                        <p> L'affidabilità della tavola di conversione dipende dalla precisione dei percentili
                            usati come
                            intervalli e la precisione di questi ultimi è funzione della numerosità
                            campionaria.
                        </p>
                        <p>
                            Per percentili
                            non estremi
                            (10°&mdash;&nbsp;90°) una quantità di osservazioni nell'ordine delle centinaia garantisce
                            stime attendibili; per
                            percentili
                            estremi
                            (1°&mdash;&nbsp;10°, 90°&mdash;&nbsp;99°) sono necessarie migliaia di
                            osservazioni, data la scarsità di informazione nelle code della distribuzione.
                        </p>
                    </li>
                    <li>
                        <p>
                            Sempre in questa pagina, viene presentata la procedura di adattamento <span
                                class="text-italic">(fitting)</span> dei dati campionari a una
                            famiglia di distribuzioni teoriche (<span class="text-italic">{% for model in
                                data.fit.fitted_models.keys() %}{{ model | replace("_", " ") | title }}{% if not
                                loop.last %}, {% endif %}{% endfor %}</span>).</p>
                        <p>
                            La distribuzione con migliore adattamento (<span class="text-italic">fit</span>) sarà
                            utilizzata
                            per confermare la generalizzabilità della tavola di conversione
                            attraverso il metodo della simulazione Monte Carlo (cfr all. {{ header }}2, pag. {{ page + 1 }}).
                        </p>
                        <p>
                            La bontà dell'adattamento (<span class="text-italic">fit</span>)
                            viene qui valutata attraverso indici di adeguatezza e grafici che
                            quantificano la capacità del modello teorico con miglior <span class="text-italic">fit</span> di riprodurre le caratteristiche distribuzionali del campione empirico.
                        </p>
                    </li>
                </ul>
            </div>

            <div class="mb-xl">
                <h3 class="mb-lg background">CARATTERISTICHE DEI DATI</h3>
                <table class="table-bordered full-width">
                    <thead>
                        <th class="text-left" style="width: 60%;">CARATTERISTICA</th>
                        <th class="text-center">VALORE</th>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-left">Metrica</td>
                            <td class="text-center">{{ get_test_label(data.metric_config.id) }}</td>
                        </tr>
                        <tr>
                            <td class="text-left">Tipo di metrica</td>
                            <td class="text-center">
                                {% if data.metric_config.metric_type == "continuous" %}
                                    continua
                                {% else %}
                                    discreta
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="text-left">Unità di misura</td>
                            <td class="text-center">{{ data.metric_config.metric_unit }}</td>
                        </tr>
                        <tr>
                            <td class="text-left">Risoluzione unità di misura</td>
                            <td class="text-center">{{ data.metric_config.metric_precision_label }}</td>
                        </tr>
                        <tr>
                            <td class="text-left">Numerosità originaria</td>
                            <td class="text-center">{{ data.load.descriptive_stats.count | int }}</td>
                        </tr>
                         <tr>
                            <td class="text-left">Numerosità dopo rimozione outlier</td>
                            <td class="text-center">{{ data.clean.metadata.final_size | int }}</td>
                        </tr>
                         <tr>
                            <td class="text-left">Numero di outlier</td>
                            <td class="text-center">{{ data.clean.metadata.removed_outliers | int }}</td>
                        </tr>
                        {% if data.metric_config.stratification.gender.label %}
                            <tr>
                                <td class="text-left">Genere</td>
                                {% set gender = data.metric_config.stratification.gender.label.split(':')[-1] %}
                                <td class="text-center">{{ gender }}</td>
                            </tr>
                        {% endif %}
                        {% if data.metric_config.stratification.age.label %}
                            <tr>
                                <td class="text-left">Fascia d'età</td>
                                {% set age = data.metric_config.stratification.age.label.split(':')[-1] %}
                                <td class="text-center">{{ age }}</td>
                            </tr>
                        {% endif %}
                        <tr>
                            <td class="text-left">Media</td>
                            <td class="text-center">{{ format_float_number | format(data.clean.descriptive_stats.mean) }}</td>
                        </tr>
                        <tr>
                            <td class="text-left">Mediana</td>
                            <td class="text-center">{{ format_float_number | format(data.clean.descriptive_stats["50%"]) }}</td>
                        </tr>
                        <tr>
                            <td class="text-left">Deviazione standard</td>
                            <td class="text-center">{{ format_float_number | format(data.clean.descriptive_stats["std"]) }}</td>
                        </tr>
                        <tr>
                            <td class="text-left">Range interquartilico</td>
                            {% set iqr = data.clean.descriptive_stats["75%"] -  data.clean.descriptive_stats["25%"] %}
                            <td class="text-center">{{ format_float_number | format(iqr) }}</td>
                        </tr>
                        <tr>
                            <td class="text-left">Minimo</td>
                            <td class="text-center">{{ format_float_number | format(data.clean.descriptive_stats.min) }}</td>
                        </tr>
                        <tr>
                            <td class="text-left">Massimo</td>
                            <td class="text-center">{{ format_float_number | format(data.clean.descriptive_stats.max) }}</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4">
                                <div class="caption">
                                    <span>Tabella {{ header }}1.1</span>
                                    <span>
                                        Il tipo di metrica oggetto di studio (continua o discreta) comporta delle differenze nelle distribuzioni teoriche e nei grafici impiegati.
                                    </span>
                                </div>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="mb-xl">
                <h3 class="mb-lg background">ADATTAMENTO DISTRIBUZIONI TEORICHE</h3>
                <table class="table-bordered full-width">
                    <thead>
                        <tr>
                            <th class="text-left">DISTRIBUZIONE</th>
                            <th class="text-center">AIC</th>
                            <th class="text-center">BIC</th>
                            <th class="text-center">CVM</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for model_name, model_data in data.fit.fitted_models.items() %}
                        <tr>
                            <td class="text-left">
                                {{ model_name | replace("_", " ") | title }}
                                {% if data.fit.best_model.name == model_name %}
                                    <span class="text-italic">&rarr; fit migliore</span>
                                {% endif %}
                            </td>
                            <td class="text-center">{{ "%.2f" | format(model_data.goodness_of_fit.aic) }}</td>
                            <td class="text-center">{{ "%.2f" | format(model_data.goodness_of_fit.bic) }}</td>
                            <td class="text-center">
                                {{ "%.2f" | format(model_data.goodness_of_fit.cramer_von_mises) }}
                                {% if model_data.goodness_of_fit.cvm_pvalue is not none %}
                                (p={{ "%.3f" | format(model_data.goodness_of_fit.cvm_pvalue) }})
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4">
                                <div class="caption">
                                    <span>Tabella {{ header }}1.3</span>
                                    <span>AIC = Akaike Information Criterion, BIC = Bayesian Information Criterion,
                                        CVM = Cramér-von Mises statistic.</span>
                                </div>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="mb-xl">
                <h3 class="mb-lg background">GRAFICI</h3>
                <div>
                    <h4 class="text-center mb-md mt-lg">Istogramma</h4>
                    <img src="{{ data.plots[0].svg }}" />
                </div>
                <div>
                    <h3 class="text-center mb-md mt-lg">
                        {% if data.metric_config.metric_type == "continuous" %}
                        Q-Q Plot
                        {% else %}
                        Rootogram
                        {% endif %}
                    </h3>
                    <img src="{{ data.plots[-1].svg }}" />
                </div>
            </div>
        </div>
        <div class="footer">{{ page }}</div>
    </div>
</div>

<!-- SECOND PAGE -->
<div class="page">
    <div class="content">
        <div>
            <!-- Page Header -->
            <div class="mb-xxl">
                <div class="header">
                    <h1 class="mb-xs">{{ data.metric_config.title | upper }}</h1>
                    <p>Allegato {{ header }}2</p>
                </div>
            </div>
            
            <!-- Page Content -->
            <h2 class="mb-xl">Percentili Bootstrap e validazione Monte Carlo</h2>
            <div class="two-columns">

                <div class="mb-xl">
                    <h3 class="mb-lg background">NOTE INTRODUTTIVE</h3>
                    <ul>
                        <li>
                            <p>
                                In questa pagina viene presentata la tecnica di stima dei percentili campionari
                                attraverso repliche <span class="text-italic">Bootstrap</span>; tale tecnica rappresenta
                                un approccio non parametrico libero da assunzioni teoriche relative alla
                                distribuzione dei dati.
                            </p>
                            <p>
                                Più precisamente, vengono generate {{ data.metric_config.bootstrap_n_samples }}
                                repliche dal <span class="text-italic">dataset</span> originario attraverso
                                ricampionamento casuale con reimmissione. Per ciascuna replica si calcolano i percentili
                                di interesse, ottenendo una distribuzione di valori. La stima finale dei percentili è
                                rappresentata dalla mediana delle relative distribuzioni.
                            </p>
                        </li>
                        <li>
                            <p>
                                La validazione dei percentili <span class="text-italic">Bootstrap</span> tramite
                                simulazione <span class="text-italic">Monte Carlo</span> costituisce un ulteriore passaggio per verificare la
                                generalizzabilità delle stime empiriche.
                            </p>
                            <p>
                                Il processo inizia identificando la distribuzione probabilistica che meglio descrive i
                                dati osservati. (cfr all. {{ header }}1, pag. {{ page }}).
                                Una volta selezionato il modello ottimale e stimati i parametri, si procede alla
                                generazione di {{ data.metric_config.montecarlo_n_samples }} campioni teorici mediante
                                simulazione  <span class="text-italic">Monte Carlo</span>. Per ogni campione sintetico vengono calcolati gli stessi
                                percentili della tecnica <span class="text-italic">Bootstrap</span>.
                            </p>
                            <p>
                                Il confronto tra percentili <span class="text-italic">Bootstrap</span> e percentli <span class="text-italic">Monte Carlo</span>
                                avviene attraverso analisi statistiche e grafici. Una buona concordanza indica che le stime percentiliche
                                ottenute con la tecnica <span class="text-italic">Bootstrap</span> sono generalizzabili.
                            </p>
                        </li>
                        <li>
                            Data la natura della popolazione concorsuale impiegata, si è deciso di impostare la numerosità delle repliche <span class="text-italic">Bootstrap</span> e dei campioni <span class="text-italic">Monte Carlo</span> a {{ data.metric_config.bootstrap_sample_size }} osservazioni.
                        </li>
                    </ul>
                </div>

                <div class="mb-xl">
                    <h3 class="mb-lg background">STIMA BOOTSTRAP DEI PERCENTILI</h3>
                    <table class="table-bordered full-width">
                        <thead>
                            <th class="text-left">PERC.LE</th>
                            <th class="text-center">STIMA BOOTSTRAP</th>
                            <th class="text-center">{{ "%.0f" | format(data.metric_config.bootstrap_ci_level * 100) }}%
                                LB</th>
                            <th class="text-center">{{ "%.0f" | format(data.metric_config.bootstrap_ci_level * 100) }}%
                                UB</th>
                        </thead>
                        <tbody>
                            {% for pct in data.bootstrap.requested_percentiles %}
                            <tr>
                                <td class="text-left">{{ pct.percentile | title }}</td>
                                <td class="text-center">{{ format_float_number | format(pct.bootstrap_value) }}</td>
                                <td class="text-center">{{ format_float_number | format(pct.bootstrap_ci_lower) }}</td>
                                <td class="text-center">{{ format_float_number | format(pct.bootstrap_ci_upper) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4">
                                    <div class="caption">
                                        <span>Tabella {{ header }}2.1:</span>
                                        <span>
                                            {{ "%.0f" | format(data.metric_config.bootstrap_ci_level * 100) }}% LB =
                                            Limite di confidenza inferiore,
                                            {{ "%.0f" | format(data.metric_config.bootstrap_ci_level * 100) }}% UB =
                                            Limite di confidenza superiore.
                                        </span>
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="mb-xl">
                    <h3 class="mb-lg background">VALIDAZIONE MONTE CARLO</h3>
                    <table class="table-bordered full-width">
                        <thead>
                            <th class="text-left">PERC.LE</th>
                            <th class="text-center">MONTE CARLO</th>
                            <th class="text-center">BOOTSTRAP</th>
                            <th class="text-center">COPERTURA</th>
                        </thead>
                        <tbody>
                            {% for pct in data.montecarlo.results %}
                            <tr>
                                <td class="text-left">{{ pct.percentile | title }}</td>
                                <td class="text-center">{{ format_float_number | format(pct.montecarlo_value) }}</td>
                                <td class="text-center">
                                    {{ format_float_number | format(pct.bootstrap_value) }}
                                </td>
                                <td class="text-center">{{ format_float_number | format(pct.coverage) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5">
                                    <div class="caption">
                                        <span>Tabella {{ header }}2.2:</span>
                                        <span>
                                            MONTE CARLO = Percentile calcolato con simulazione Monte Carlo,
                                            BOOTSTRAP = Percentile stimato con tecnica Bootstrap, COPERTURA = Percentuale
                                            di casi in cui il valore del percentile calcolato con simulazione Monte
                                            Carlo è contenuto nell'intervallo di confidenza stimato con tecnica
                                            Bootstrap.
                                        </span>
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="mb-xl">
                    <h3 class="mb-lg background">GRAFICI</h3>
                    <div>
                        <h4 class="text-center mb-md mt-lg">Percentili Bootstrap</h4>
                        <img src="{{ data.plots[1].svg }}" />
                    </div>
                    <div>
                        <h3 class="text-center mb-md mt-lg">Bootstrap vs Monte Carlo</h3>
                        <img src="{{ data.plots[-2].svg }}" />
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">{{ page + 1 }}</div>
    </div>
</div>

<!-- THIRD PAGE -->
<div class="page">
    <div class="content">
        <div>
            <!-- Page Header -->
            <div class="mb-xxl">
                <div class="header">
                    <h1 class="mb-xs">{{ data.metric_config.title | upper }}</h1>
                    <p>Allegato {{ header }}3</p>
                </div>
            </div>
            <!-- Page Content -->
            <h2 class="mb-xl">Tavola di conversione percentilica</h2>
            <div class="mb-xl text-small">
                <p>Tipo di prova = {{ get_test_label(data.metric_config.id) }}</p>
                <p>Numerosità del campione: {{ data.clean.descriptive_stats.count | int }}</p>
                {% set strat = data.metric_config.stratification %}
                {% if "recruitment_year" in strat %}
                    <p>{{ strat.recruitment_year.label }}</p>
                {% endif %}
                {% if "recruitment_type" in strat %}
                    <p>{{ strat.recruitment_type.label }}</p>
                {% endif %}
                {% if "gender" in strat %}
                    <p>{{ strat.gender.label }}</p>
                {% endif %}
                {% if "age" in strat %}
                    <p>{{ strat.age.label }}</p>
                {% endif %}
            </div>
            <div class="mb-xl">
                <table class="table-bordered table-striped table-padded">
                    <thead>
                        <th class="text-center">FASCIA</th>
                        <th class="text-center">PUNTEGGIO</th>
                        <th class="text-center">LIMITE INFERIORE</th>
                        <th class="text-center">LIMITE SUPERIORE</th>
                    </thead>
                    <tbody>
                        {% for cutoff in data.bootstrap.cutoffs %}
                        <tr>
                            <td class="text-center">
                                {{ loop.index | int }}
                            </td>
                            <td class="text-center">
                                {{ "%.2f" | format(data.metric_config.awarded_scores[loop.index0]) }}
                            </td>
                            <td class="text-center">
                                {% if loop.first %}
                                    &mdash;
                                {% else %}
                                    {% if data.metric_config.metric_type == "continuous" %}
                                        {% if data.metric_config.metric_subtype == "time" %}
                                            da {{ (cutoff[0] + (1 / (10 ** data.metric_config.metric_precision))) | format_seconds(data.metric_config.metric_precision) }}
                                        {% else %}
                                            da {{ (cutoff[0] + (1 / (10 ** data.metric_config.metric_precision))) | round(data.metric_config.metric_precision) }}
                                        {% endif %}
                                    {% else %}
                                        da {{ format_float_number | format(cutoff[0] + 1) }}
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if loop.last %}
                                &mdash;
                                {% else %}
                                    {% if data.metric_config.metric_type == "continuous" %}
                                        {% if data.metric_config.metric_subtype == "time" %}
                                            fino a {{ cutoff[1] | format_seconds(data.metric_config.metric_precision) }}
                                        {% else %}
                                            fino a {{ format_float_number | format(cutoff[1]) | round(data.metric_config.metric_precision) }}
                                        {% endif %}
                                    {% else %}
                                        fino a {{ format_float_number | format(cutoff[1]) }}
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="footer">{{ page + 2 }}</div>
    </div>
</div>

<!-- FOURTH PAGE -->
<div class="page">
    <div class="content">
        <div>
             <!-- Page Header -->
            <div class="mb-xxl">
                <div class="header">
                    <h1 class="mb-xs">{{ data.metric_config.title | upper }}</h1>
                    <p>Allegato {{ header }}4</p>
                </div>
            </div>
            
            <!-- Page Content -->
            <h2 class="mb-xl">Verifica della stabilità della tavola di conversione</h2>
            <div class="two-columns">
                <div class="mb-xl">
                    <h3 class="mb-lg background">NOTE INTRODUTTIVE</h3>
                    <ul>
                        <li>
                            <p>
                                In questa pagina viene presentata un'analisi della stabilità della tavola di conversione (cfr all. {{ header }}3, pag. {{ page + 2 }}) quando applicata a campioni di diversa consistenza numerica ({{data.bootstrap.cutoffs_test.sample_sizes | join(", ")}} osservazioni).
                            </p>
                        </li>
                        <li>
                            <p>
                                Per ciascuna delle {{ data.bootstrap.cutoffs_test.sample_sizes | length }} numerosità considerate, vengono generati 1000 campioni derivati dal <span class="text-italic">dataset</span> originario. Viene quindi applicata la tavola di conversione ai punteggi grezzi di ogni campione, calcolando la proporzione di osservazioni che ricade in ciascuna fascia percentilica. Si ottiene così una distribuzione di proporzioni per ogni fascia e numerosità campionaria.
                            </p>
                        </li>
                        <li>
                            <p>
                                <span class="text-bold">Attenzione</span>: la somma <span class="text-italic">between</span> dei valori OS non ha significato poiché ogni dato corrisponde alla mediana <span class="text-italic">within</span> delle distribuzioni osservate.
                            </p>
                        </li>
                    </ul>
                </div>
                {% for sample_size in data.bootstrap.cutoffs_test.sample_sizes %}
                    <div class="mb-xl">
                        <h3 class="mb-lg background">STABILITÀ CON N={{ sample_size }}</h3>
                        <table class="table-bordered full-width mb-xl">
                            <thead>
                                <tr>
                                    <th class="text-center" style="width: 18%">FA</th>
                                    <th class="text-center" style="width: 18%">AT</th>
                                    <th class="text-center" style="width: 18%">OS</th>
                                    <th class="text-center" style="width: 18%">AM</th>
                                    <th class="text-center" style="width: 28%">IF</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in data.bootstrap.cutoffs_test.results %}
                                    {% if row.sample_size == sample_size %}
                                        <tr>
                                            <td class="text-center">{{ row.perc_step | int }}</td>
                                            <td class="text-center">{{ "%.2f" | format(row.expected_proportion) }}</td>
                                            <td class="text-center">{{ "%.2f" | format(row.p50) }}</td>
                                            <td class="text-center">{{ "%.2f" | format(row.p90 - row.p10) }}</td>
                                            <td class="text-center">[ {{ "%05.2f" | format(row.p10) }} &mdash; {{ "%05.2f" | format(row.p90) }} ]</td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5">
                                        <div class="caption">
                                            <span>Tabella {{ header }}4.{{ loop.index }}</span>
                                            <span>
                                                FA = Fascia, AT = Percentile atteso, OS = Percentile osservato, AM = Ampiezza intervallo di fluttuazione, IF = Intervallo di fluttuazione 10%-90%.
                                            </span>
                                        </div>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                {% endfor %}
            </div>
        </div>
        <div class="footer">{{ page + 3 }}</div>
    </div>
</div>
{% endblock %}