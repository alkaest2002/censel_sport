{% extends "_base.html" %}

{% block report_style %}
<style>
    
    img {
        width: 100%;
    }

    .content {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .content div:first-child {
        flex-grow: 1;
    }

    .two-columns {
        column-width: 50ch;
        column-gap: 5rem;
    }

    .two-columns>* {
        break-inside: avoid;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid var(--base-border-color);
        padding-bottom: 0.5rem;
    }

    .footer {
        font-size: .7rem;
        line-height: .9rem;
        text-align: center;
        padding-top: 12px;
        border-top: 2px solid var(--base-border-color);
    }

    .normative-table th, .normative-table td {
        padding: 8px 18px;
    }

    .normative-table th {
        background-color: #fff;
        color: var(--black);
    }

    .caption {
        display: inline-block;
        margin-right: 3px;
    }
</style>
{% endblock %}

{% block body %}
{% set format_float_number = "%." + data.metric_config.metric_precision | string + "f" %}

<!-- FIRST PAGE -->
<div class="page">
    <div class="content">
        <div>
            <!-- Page Header -->
            <div class="mb-xxl">
                <div class="header">
                    <h1 class="mb-xs">{{ data.metric_config.title | upper }}</h1>
                    {% if header_numbering %}
                        <p>Allegato {{ header_numbering[0] }}</p>
                    {% endif %}
                </div>
            </div>
            <!-- Page Content -->
            <h2 class="mb-xl">Campione di riferimento</h2>
            <div class="two-columns">
    
                <div class="mb-xl">
                    <h3 class="mb-lg">Note introduttive</h3>
                    <ul>
                        <li>
                            <p>
                                In questa pagina vengono presentate le informazioni relative al campione
                                utilizzato per la
                                costruzione della tabella percentilica relativa a: <span class="text-italic text-underline">{{
                                    data.metric_config.title }}</span>. Tale tabella consente la conversione dei punteggi
                                grezzi in punteggi standardizzati.
                            </p>
                            <p> L'affidabilità della tabella di conversione dipende dalla precisione dei percentili
                                usati come
                                soglie e la precisione di questi ultimi è funzione della numerosità
                                campionaria.
                                Per percentili
                                non estremi
                                (10°&mdash;&nbsp;90°) un numero di osservazioni nell'ordine delle centinaia garantisce
                                stime attendibili; per
                                percentili
                                estremi
                                (1°&mdash;&nbsp;10°, 90°&mdash;&nbsp;99°) sono necessarie migliaia di
                                osservazioni, data la scarsità di valori nelle code della distribuzione.
                            </p>
                        </li>
                        <li>
                            <p>
                                Sempre in questa pagina, viene presentata la procedura di <span
                                    class="text-italic">fitting</span> dei dati campionari a una
                                famiglia di distribuzioni teoriche {% if data.metric_config.metric_type == "continuous" %}(<span
                                    class="text-italic">Normale, Log-normale, Gamma, Weibull</span>){% else %}(<span
                                    class="text-italic">Binomiale negativa, Poisson, Poisson con inflazione di
                                    zeri</span>){%
                                endif %}.</p>
                            <p>
                                La distribuzione con migliore adattamento (<span class="text-italic">fit</span>) sarà utilizzata
                                per confermare l'affidabilità della tabella di conversione
                                attraverso il metodo della simulazione Monte Carlo {% if header_numbering
                                %}(cfr allegato {{ header_numbering[1] }}){% else %}(vedi pagina successiva){% endif %}.
                            </p>
                            <p>
                                La bontà dell'adattamento (<span class="text-italic">fit</span>) viene qui valutata attraverso indici di adeguatezza (AIC, BIC, CVM) 
                                e analisi grafica mediante <span class="text-italic">{% if data.metric_config.metric_type == "continuous" %}Q-Q plot{% else %}Rootogram{% endif %}</span> che
                                quantificano la capacità delle distribuzioni teoriche di riprodurre le caratteristiche
                                distribuzionali del campione empirico.
                            </p>
                        </li>
                    </ul>
                </div>
                <div class="mb-xl">
                    <h3 class="mb-lg">Caratteristiche dei dati</h3>
                    <table class="table-bordered full-width">
                        <thead>
                            <th class="text-left" style="width: 60%;">FEATURE</th>
                            <th class="text-center">VALUE</th>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="text-left">SAMPLE SIZE</td>
                                <td class="text-center">{{ data.clean.descriptive_stats.count | int }}</td>
                            </tr>
                            <tr>
                                <td class="text-left">UNIT</td>
                                <td class="text-center">{{ data.metric_config.metric_unit }}</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4">
                                    <span class="caption text-bold">Tabella {{ header_numbering[0] }}.1</span> SAMPLE SIZE = Num.tà campionaria, UNIT = Unità di misura.
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
    
                <div class="mb-xl">
                    <h3 class="mb-lg">Statistiche descrittive</h3>
                    <table class="table-bordered full-width">
                        <thead>
                            <th class="text-left" style="width: 60%;">STATISTICS</th>
                            <th class="text-center">VALUE</th>
                        </thead>
                        <tbody>
                            {% for key, value in data.clean.descriptive_stats.items() %}
                                {% if loop.index0 > 0 %}
                                    <tr>
                                        <td class="text-left">{{ key | upper }}</td>
                                        <td class="text-center">{{ format_float_number | format(value) }}</td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2">
                                    <span class="caption text-bold">Tabella {{ header_numbering[0] }}.2</span>
                                    MEAN = Media,
                                    STD = Dev.ne standard, 
                                    MIN = Minimo, 
                                    25% = Primo quartile, 
                                    50% = Mediana, 
                                    75% = Terzo quartile,
                                    MAX = Massimo
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
    
                <div class="mb-xl">
                    <h3 class="mb-lg">Fitting delle distribuzioni teoriche</h3>
                    <table class="table-bordered full-width">
                        <thead>
                            <tr>
                                <th class="text-left">MODEL</th>
                                <th class="text-center">AIC</th>
                                <th class="text-center">BIC</th>
                                <th class="text-center">CVM</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for model_name, model_data in data.fit.fitted_models.items() %}
                            <tr>
                                <td class="text-left">{{ model_name | upper | replace("_", " ") }}</td>
                                <td class="text-center">{{ "%.2f" | format(model_data.goodness_of_fit.aic) }}</td>
                                <td class="text-center">{{ "%.2f" | format(model_data.goodness_of_fit.bic) }}</td>
                                <td class="text-center">
                                    {{ "%.2f" | format(model_data.goodness_of_fit.cramer_von_mises) }}
                                    {% if model_data.goodness_of_fit.cvm_pvalue is not none %}
                                        (p={{ "%.3f" | format(model_data.goodness_of_fit.cvm_pvalue) }})
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4">
                                    <span class="caption text-bold">Tabella {{ header_numbering[0] }}.3</span> AIC = Akaike Information Criterion, BIC = Bayesian Information Criterion, CVM = Cramér-von Mises statistic.
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
    
                <div class="mb-xl">
                    <h3 class="mb-lg">Grafici</h3>
                    <div>
                        <h4 class="text-center mb-md mt-lg">ISTOGRAMMA DEL CAMPIONE</h4>
                        <img src="{{ data.plots[0].svg }}" />
                    </div>
                    <div>
                        <h3 class="text-center mb-md mt-lg">
                            {% if data.metric_config.metric_type == "continuous" %}
                                Q-Q PLOT
                            {% else %}
                                ROOTOGRAM
                            {% endif %}
                        </h3>
                        <img src="{{ data.plots[-1].svg }}" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SECOND PAGE -->
<div class="page">
    <div class="content">
        <div>
            <!-- Page Header -->
            <div class="mb-xxl">
                <div class="header">
                    <h1 class="mb-xs">{{ data.metric_config.title | upper }}</h1>
                    {% if header_numbering %}
                        <p>Allegato {{ header_numbering[1] }}</p>
                    {% endif %}
                </div>
            </div>
            <!-- Page Content -->
            <h2 class="mb-xl">Percentili bootstrap e validazione Monte Carlo</h2>
            <div class="two-columns">
    
                <div class="mb-xl">
                    <h3 class="mb-lg">Note introduttive</h3>
                    <ul>
                        <li>
                            <p>
                                In questa pagina viene presentata la tecnica di stima dei percentili campionari attraverso repliche <span class="text-italic">bootstrap</span>; tale tecnica rappresenta un approccio non parametrico e cioè libero da assunzioni teoriche  relative alla distribuzione dei dati.
                            </p>
                            <p>
                                Più precisamente, vengono generate {{ data.metric_config.bootstrap_n_replicates }} repliche dal <span class="text-italic">dataset</span> originale attraverso ricampionamento casuale con reimmissione. Per ciascuna replica si calcolano i percentili di interesse, ottenendo una distribuzione di {{ data.metric_config.bootstrap_n_replicates }} valori. La stima finale dei percentili è rappresentata dalla mediana delle relative distribuzioni.

                            </p>
                        </li>
                        <li>
                            <p>
                                La validazione dei percentili <span class="text-italic">bootstrap</span> tramite simulazione Monte Carlo costituisce un ulteriore passaggio per verificare la generalizzabilità delle stime empiriche.
                            </p>
                            <p>
                                Il processo inizia identificando la distribuzione probabilistica che meglio descrive i dati osservati. {% if header_numbering %}(cfr allegato {{ header_numbering[0] }}){% else %}(vedi pagina precedente){% endif %}.
                                Una volta selezionato il modello ottimale e stimati i parametri, si procede alla generazione di {{ data.metric_config.montecarlo_n_samples }} campioni teorici mediante simulazione Monte Carlo. Per ogni campione simulato vengono calcolati gli stessi percentili della tecnica <span class="text-italic">bootstrap</span>, creando una distribuzione teorica di riferimento.
                            </p>
                            <p>
                                Il confronto tra percentili <span class="text-italic">bootstrap</span> e quelli teorici avviene attraverso analisi statistiche che valutano differenze assolute e relative e rappresentazioni grafiche. Una buona concordanza indica che le stime percentiliche ottenute con la tecnica <span class="text-italic">bootstrap</span> sono generalizzabili.
                            </p>
                        </li>
                    </ul>
                </div>
    
                <div class="mb-xl">
                    <h3 class="mb-lg">Descrittive percentili bootstrap</h3>
                    <table class="table-bordered full-width">
                        <thead>
                            <th class="text-left">PERC.LE</th>
                            <th class="text-center">BOOTSTRAP VALUE</th>
                            <th class="text-center">{{ "%.0f" | format(data.metric_config.bootstrap_ci_level * 100) }}% LB</th>
                            <th class="text-center">{{ "%.0f" | format(data.metric_config.bootstrap_ci_level * 100) }}% UB</th>
                        </thead>
                        <tbody>
                            {% for pct in data.bootstrap.percentiles %}
                                <tr>
                                    <td class="text-left">{{ pct.percentile | upper }}</td>
                                    <td class="text-center">{{ format_float_number | format(pct.value) }}</td>
                                    <td class="text-center">{{ format_float_number | format(pct.ci_lower) }}</td>
                                    <td class="text-center">{{ format_float_number | format(pct.ci_upper) }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4">
                                    <span class="caption text-bold">Tabella {{ header_numbering[1] }}.1:</span>
                                    BOOTSTRAP VALUE = stima Bootstrap del percentile, 
                                    {{ "%.0f" | format(data.metric_config.bootstrap_ci_level * 100) }}% LB = Limite di confidenza inferiore,
                                    {{ "%.0f" | format(data.metric_config.bootstrap_ci_level * 100) }}% UB = Limite di confidenza superiore.
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
    
                <div class="mb-xl">
                    <h3 class="mb-lg">Validazione Monte Carlo</h3>
                    <table class="table-bordered full-width">
                        <thead>
                            <th class="text-left">PERC.LE</th>
                            <th class="text-center">MONTE CARLO</th>
                            <th class="text-center">BOOTSTRAP</th>
                            <th class="text-center">COVERAGE</th>
                        </thead>
                        <tbody>
                            {% for pct in data.montecarlo.results %}
                            <tr>
                                <td class="text-left">{{ pct.percentile | upper }}</td>
                                <td class="text-center">{{ format_float_number | format(pct.montecarlo_value) }}</td>
                                <td class="text-center">
                                    {{ format_float_number | format(pct.bootstrap_value) }}
                                </td>
                                <td class="text-center">{{ format_float_number | format(pct['coverage_%']) }} %</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5">
                                    <span class="caption text-bold">Tabella {{ header_numbering[1] }}.2:</span> MONTE CARLO = Percentile calcolato tramite simulazione Monte Carlo, BOOTSTRAP = Percentile stimato con tecnica bootstrap, COVERAGE = Percentuale di casi in cui il valore del percentile calcolato tramite simulazione Monte Carlo è contenuto nell'intervallo di confidenza stimato con la tecnica bootstrap.</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
    
                <div class="mb-xl">
                    <h3 class="mb-lg">Grafici</h3>
                    <div>
                        <h4 class="text-center mb-md mt-lg">PERCENTILI BOOTSTRAP</h4>
                        <img src="{{ data.plots[1].svg }}" />
                    </div>
                    <div>
                        <h3 class="text-center mb-md mt-lg">PERCENTILI BOOTSTRAP vs MONTECARLO</h3>
                        <img src="{{ data.plots[-2].svg }}" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- THIRD PAGE -->
 <div class="page">
    <div class="content">
        <div>
            <!-- Page Header -->
            <div class="mb-xxl">
                <div class="header">
                    <h1 class="mb-xs">{{ data.metric_config.title | upper }}</h1>
                    {% if header_numbering %}
                        <p>Allegato {{ header_numbering[2] }}</p>
                    {% endif %}
                </div>
            </div>
            <!-- Page Content -->
            <h2 class="mb-xl">Tavole normative percentiliche</h2>
            <div class="mb-xl">
                <table class="table-bordered table-striped normative-table">
                    <thead>
                        <th class="text-center">FASCIA</th>
                        <th class="text-center">LIMITE INFERIORE</th>
                        <th class="text-center">LIMITE SUPERIORE</th>
                        <th class="text-center">PUNTEGGIO</th>
                    </thead>
                    <tbody>
                        {% for cutoff in data.bootstrap.cutoffs %}
                        <tr>
                            <td class="text-center">
                                {{ loop.index }}
                            </td>
                            <td class="text-center">
                                {% if loop.first %}
                                    &mdash;
                                {% else %}
                                    {% if data.metric_config.metric_type == "continuous" %}
                                        {% if data.metric_config.metric_subtype == "time" %}
                                            da {{ (cutoff[0] + (1  / (10 ** data.metric_config.metric_precision))) | format_seconds }}
                                        {% else %}
                                            da {{ format_float_number | format(cutoff[0]) }}
                                        {% endif %}
                                    {% else %}
                                        da {{ format_float_number | format(cutoff[0] + 1) }}
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if loop.last %}
                                    &mdash;
                                {% else %}
                                    {% if data.metric_config.metric_type == "continuous" %}
                                        {% if data.metric_config.metric_subtype == "time" %}
                                            fino a {{ cutoff[1] | format_seconds }}
                                        {% else %}
                                            fino a {{ format_float_number | format(cutoff[1]) }}
                                        {% endif %} 
                                    {% else %}
                                        fino a {{ format_float_number | format(cutoff[1]) }}
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {{ "%.2f" | format(data.metric_config.awarded_scores[loop.index0]) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
 </div>
{% endblock %}